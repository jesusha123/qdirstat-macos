# Building QDirStat

The following instructions explain how to build a disk image (.dmg) containing QDirStat Universal Binaries. This means they support both arm64 (Apple silicon) and x86_64 (Intel) platforms with a single binary.

## Requirements

- Xcode 15.2
- Qt 5 Open Source with support for Universal Binaries
- [create-dmg](https://github.com/create-dmg/create-dmg)
- An Apple Developer account

**Note:** The Qt Company as of Qt 5.15.12 does not officially support Universal Binaries. Qt 5 needs to be built manually from sources: [Build Qt](#build-qt).

## Build notarized QDirStat disk image

- Download latest [QDirStat source code](https://github.com/shundhammer/qdirstat/releases/tag/1.9) and extract
- Run the following commands
```shell
# Build QDirStat.app
/usr/local/Qt-5.15.12/bin/qmake QMAKE_APPLE_DEVICE_ARCHS="x86_64 arm64"
make
cd src
mv qdirstat.app QDirStat.app

# Add Frameworks and prepare for notarization
/usr/local/Qt-5.15.12/bin/macdeployqt QDirStat.app -sign-for-notarization=<APPLE_DEVELOPER_ID> -dmg

# Delete QDirStat.dmg generated by macdeployqt and instead use create-dmg to add an Applications shortcut. This is so we can drag QDirStat.app to the /Applications directory.
rm QDirStat.dmg

# Create final disk image, and notarize
create-dmg --volname "QDirStat" --codesign <APPLE_DEVELOPER_ID> --notarize "notarytool-password" --window-pos 200 120 --window-size 650 400 --app-drop-link 500 0 "QDirStat-version.dmg" "QDirStat.app"
```


## Build Qt

The instructions used to build Qt 5 with Universal Binary support come from [downtowndoughbrown.com](https://www.downtowndougbrown.com/2023/08/how-to-create-a-qt-5-arm-intel-universal-binary-for-mac/), but they have been slightly modified to not disable openssl, and to add a patch that fixes [QTBUG-117225](https://bugreports.qt.io/browse/QTBUG-117225).

- Download [Qt 5.15.12 source code](https://download.qt.io/official_releases/qt/5.15/5.15.12/single/) and extract the compressed file.
- Execute the following commands on a terminal
```shell
tar -xvf qt-everywhere-src-5.15.12.tar.xz
cd qt-everywhere-src-5.15.12
```
- Apply [this patch](https://codereview.qt-project.org/c/qt/qtbase/+/503172) to Qt source code, then continue executing the commands below.
```
export PATH=$PATH:$(pwd)/qtbase/bin 
cd qtbase
./configure QMAKE_APPLE_DEVICE_ARCHS="x86_64 arm64" -release -opensource -confirm-license -nomake examples -nomake tests 
make -j$(sysctl -n hw.ncpu)
sudo make install
cd ../qttools
qmake
make -j$(sysctl -n hw.ncpu)
sudo make install
cd ../qtmacextras
qmake
make -j$(sysctl -n hw.ncpu)
sudo make install
```

The `sudo make install` commands will install Qt to `/usr/local/Qt-5.15.12`


### Alternatives to building Qt

#### Qt Online Installer

The Qt Online Installer installs Qt 5 with x86_64 binaries, and no support for arm64 binaries. This works well for Intel machines, but it is less than ideal for Apple silicon machines, as Rosetta is needed to translate binary code.

#### Qt installed from Homebrew

Homebrew installs Qt 5 with arm64 binaries. This does not help in building binaries for Intel machines. It might be possible to build Qt 5 with Universal Binary support from sources with Homebrew, but my attempts failed.
